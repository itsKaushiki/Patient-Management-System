#!/bin/bash
set -e

# Set Java 21 as the Java version for this script
export JAVA_HOME=$(/usr/libexec/java_home -v 21)
export PATH="$JAVA_HOME/bin:$PATH"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Integration Test Suite${NC}"
echo -e "${GREEN}========================================${NC}"

# Function to check if services are running
check_services_running() {
    local services_running=true

    # Check if API Gateway is running
    if ! curl -s -f "http://localhost:4004/actuator/health" > /dev/null 2>&1; then
        services_running=false
    fi

    # Check if Auth Service is running
    if ! curl -s -f "http://localhost:4005/actuator/health" > /dev/null 2>&1; then
        services_running=false
    fi

    if [ "$services_running" = true ]; then
        return 0
    else
        return 1
    fi
}

# Main execution
main() {
    local SERVICES_WERE_RUNNING=false

    # Check if services are already running
    if check_services_running; then
        echo -e "${YELLOW}Services are already running. Using existing services.${NC}"
        SERVICES_WERE_RUNNING=true
    else
        echo -e "${YELLOW}Starting all services...${NC}"
        ./start

        # Wait a bit for services to stabilize
        echo -e "${YELLOW}Waiting for services to stabilize...${NC}"
        sleep 5

        # Check if services started successfully
        if ! check_services_running; then
            echo -e "${RED}Services failed to start. Stopping...${NC}"
            ./stop
            exit 1
        fi
    fi

    # Run integration tests
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Running Integration Tests${NC}"
    echo -e "${GREEN}========================================${NC}"

    cd integration-tests

    # Run tests using Maven and capture output
    if mvn test 2>&1 | tee /tmp/test-output.log; then
        TEST_RESULT=0
        echo ""
        echo -e "${GREEN}========================================${NC}"
        echo -e "${GREEN}✓ ALL TESTS PASSED${NC}"
        echo -e "${GREEN}========================================${NC}"

        # Extract test summary
        TESTS_RUN=$(grep "Tests run:" /tmp/test-output.log | tail -1 | sed 's/.*Tests run: \([0-9]*\).*/\1/')
        if [ -n "$TESTS_RUN" ]; then
            echo -e "${GREEN}Total tests run: $TESTS_RUN${NC}"
        fi
    else
        TEST_RESULT=1
        echo ""
        echo -e "${RED}========================================${NC}"
        echo -e "${RED}✗ TESTS FAILED${NC}"
        echo -e "${RED}========================================${NC}"

        # Extract and show failure details
        echo -e "${RED}Failed tests:${NC}"
        grep -A 2 "FAILURE!" /tmp/test-output.log | grep -E "^\[ERROR\]" | sed 's/\[ERROR\]//' || echo "See output above for details"
    fi

    cd ..

    # Stop services only if we started them
    if [ "$SERVICES_WERE_RUNNING" = false ]; then
        echo -e "${YELLOW}Stopping all services...${NC}"
        ./stop
    else
        echo -e "${YELLOW}Leaving services running (they were already running before tests)${NC}"
    fi

    # Exit with test result
    exit $TEST_RESULT
}

main

