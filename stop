#!/bin/bash

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

PIDS_FILE=".services.pids"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Stopping Microservices System${NC}"
echo -e "${GREEN}========================================${NC}"

# Function to stop Spring Boot services
stop_services() {
    if [ ! -f "$PIDS_FILE" ]; then
        echo -e "${YELLOW}No PIDs file found. Services may not be running.${NC}"
        return
    fi
    
    echo -e "${YELLOW}Stopping Spring Boot services...${NC}"
    
    while IFS=: read -r service_name pid; do
        if [ -n "$pid" ]; then
            if ps -p "$pid" > /dev/null 2>&1; then
                echo -e "${YELLOW}Stopping $service_name (PID: $pid)...${NC}"
                kill "$pid" 2>/dev/null || true
                
                # Wait for graceful shutdown (max 10 seconds)
                for i in {1..10}; do
                    if ! ps -p "$pid" > /dev/null 2>&1; then
                        echo -e "${GREEN}✓ $service_name stopped${NC}"
                        break
                    fi
                    sleep 1
                done
                
                # Force kill if still running
                if ps -p "$pid" > /dev/null 2>&1; then
                    echo -e "${YELLOW}Force killing $service_name...${NC}"
                    kill -9 "$pid" 2>/dev/null || true
                    echo -e "${GREEN}✓ $service_name force stopped${NC}"
                fi
            else
                echo -e "${YELLOW}$service_name (PID: $pid) is not running${NC}"
            fi
        fi
    done < "$PIDS_FILE"
    
    rm -f "$PIDS_FILE"
}

# Function to stop Docker containers
stop_infrastructure() {
    echo -e "${YELLOW}Stopping infrastructure services...${NC}"
    docker compose down
    echo -e "${GREEN}✓ Infrastructure services stopped${NC}"
}

# Function to kill any remaining Spring Boot processes
kill_remaining_processes() {
    echo -e "${YELLOW}Checking for remaining Spring Boot processes...${NC}"

    # Find and kill any remaining spring-boot:run processes
    if pgrep -f "spring-boot:run" > /dev/null 2>&1; then
        echo -e "${YELLOW}Found remaining Spring Boot processes. Stopping them...${NC}"
        pkill -f "spring-boot:run"
        sleep 2

        # Force kill if still running
        if pgrep -f "spring-boot:run" > /dev/null 2>&1; then
            echo -e "${YELLOW}Force killing remaining processes...${NC}"
            pkill -9 -f "spring-boot:run"
        fi
        echo -e "${GREEN}✓ All Spring Boot processes stopped${NC}"
    else
        echo -e "${GREEN}✓ No remaining Spring Boot processes found${NC}"
    fi
}

# Main execution
main() {
    stop_services
    kill_remaining_processes
    stop_infrastructure

    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}All Services Stopped${NC}"
    echo -e "${GREEN}========================================${NC}"
}

main

