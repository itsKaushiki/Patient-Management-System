#!/bin/bash
set -e

# Set Java 21 as the Java version for this script
export JAVA_HOME=$(/usr/libexec/java_home -v 21)
export PATH="$JAVA_HOME/bin:$PATH"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

PIDS_FILE=".services.pids"
LOGS_DIR="logs"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Starting Microservices System${NC}"
echo -e "${GREEN}========================================${NC}"

# Create logs directory
mkdir -p "$LOGS_DIR"

# Note: We don't clean target directories here because:
# 1. It removes compiled protobuf classes
# 2. The compile step in start_service() will handle incremental builds
# If you need a clean build, run: ./mvnw clean in each service directory

# Function to check if Colima is running
check_colima() {
    echo -e "${YELLOW}Checking Colima status...${NC}"
    if ! colima status &>/dev/null; then
        echo -e "${YELLOW}Colima is not running. Starting Colima...${NC}"
        colima start
        sleep 5
    else
        echo -e "${GREEN}✓ Colima is running${NC}"
    fi
}

# Function to wait for a service health endpoint
wait_for_health() {
    local service_name=$1
    local port=$2
    local max_attempts=60
    local attempt=0
    
    echo -e "${YELLOW}Waiting for $service_name to be healthy on port $port...${NC}"
    
    while [ $attempt -lt $max_attempts ]; do
        if curl -s -f "http://localhost:$port/actuator/health" > /dev/null 2>&1; then
            echo -e "${GREEN}✓ $service_name is healthy${NC}"
            return 0
        fi
        attempt=$((attempt + 1))
        sleep 2
    done
    
    echo -e "${RED}✗ $service_name failed to become healthy${NC}"
    return 1
}

# Function to wait for infrastructure
wait_for_infrastructure() {
    echo -e "${YELLOW}Waiting for infrastructure services...${NC}"
    
    # Wait for PostgreSQL databases
    echo -e "${YELLOW}Waiting for auth-service-db...${NC}"
    until docker exec auth-service-db pg_isready -U admin_user -d db &>/dev/null; do
        sleep 2
    done
    echo -e "${GREEN}✓ auth-service-db is ready${NC}"
    
    echo -e "${YELLOW}Waiting for patient-service-db...${NC}"
    until docker exec patient-service-db pg_isready -U admin_user -d db &>/dev/null; do
        sleep 2
    done
    echo -e "${GREEN}✓ patient-service-db is ready${NC}"
    
    # Wait for Kafka
    echo -e "${YELLOW}Waiting for Kafka...${NC}"
    local kafka_ready=false
    for i in {1..30}; do
        if docker exec kafka kafka-broker-api-versions --bootstrap-server localhost:9092 &>/dev/null; then
            kafka_ready=true
            break
        fi
        sleep 2
    done
    
    if [ "$kafka_ready" = true ]; then
        echo -e "${GREEN}✓ Kafka is ready${NC}"
    else
        echo -e "${RED}✗ Kafka failed to start${NC}"
        exit 1
    fi
}

# Function to fix Maven wrapper permissions
fix_mvnw_permissions() {
    echo -e "${YELLOW}Fixing Maven wrapper permissions...${NC}"
    chmod +x */mvnw 2>/dev/null || true
    echo -e "${GREEN}✓ Maven wrapper permissions fixed${NC}"
}

# Function to start a Spring Boot service
start_service() {
    local service_name=$1
    local service_dir=$2
    local port=$3

    echo -e "${YELLOW}Compiling $service_name...${NC}"

    cd "$service_dir"
    # Compile the service first to ensure protobuf classes are generated
    ./mvnw compile > "../$LOGS_DIR/$service_name-compile.log" 2>&1
    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ Failed to compile $service_name. Check $LOGS_DIR/$service_name-compile.log${NC}"
        cd - > /dev/null
        exit 1
    fi
    echo -e "${GREEN}✓ $service_name compiled${NC}"

    echo -e "${YELLOW}Starting $service_name...${NC}"
    ./mvnw spring-boot:run -Dspring-boot.run.profiles=local -Dspring-boot.run.arguments="--server.port=$port" > "../$LOGS_DIR/$service_name.log" 2>&1 &
    local pid=$!
    cd - > /dev/null

    echo "$service_name:$pid" >> "../$PIDS_FILE"
    echo -e "${GREEN}✓ $service_name started (PID: $pid)${NC}"
}

# Main execution
main() {
    # Clean up old PIDs file
    rm -f "$PIDS_FILE"
    
    # Check Colima
    check_colima
    
    # Start infrastructure with docker compose
    echo -e "${YELLOW}Starting infrastructure services...${NC}"
    docker compose up -d
    
    # Wait for infrastructure to be ready
    wait_for_infrastructure
    
    # Fix Maven wrapper permissions
    fix_mvnw_permissions
    
    # Start services in order
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Starting Spring Boot Services${NC}"
    echo -e "${GREEN}========================================${NC}"
    
    start_service "auth-service" "auth-service" 4005
    wait_for_health "auth-service" 4005
    
    start_service "billing-service" "billing-service" 4001
    wait_for_health "billing-service" 4001
    
    start_service "patient-service" "patient-service" 4000
    wait_for_health "patient-service" 4000
    
    start_service "analytics-service" "analytics-service" 4002
    wait_for_health "analytics-service" 4002
    
    start_service "api-gateway" "api-gateway" 4004
    wait_for_health "api-gateway" 4004
    
    # Print summary
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}All Services Started Successfully!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo -e "${GREEN}Service Ports:${NC}"
    echo -e "  API Gateway:      http://localhost:4004"
    echo -e "  Auth Service:     http://localhost:4005"
    echo -e "  Patient Service:  http://localhost:4000"
    echo -e "  Billing Service:  http://localhost:4001 (HTTP), localhost:9001 (gRPC)"
    echo -e "  Analytics Service: http://localhost:4002"
    echo ""
    echo -e "${GREEN}Infrastructure:${NC}"
    echo -e "  Auth DB:          localhost:5432"
    echo -e "  Patient DB:       localhost:5433"
    echo -e "  Kafka:            localhost:9092"
    echo ""
    echo -e "${YELLOW}Logs are available in: $LOGS_DIR/${NC}"
    echo -e "${YELLOW}To stop all services, run: ./stop${NC}"
}

main

